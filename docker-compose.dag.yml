# Docker Compose for DAG Pipeline Testing
# Usage: docker-compose -f docker-compose.dag.yml up
#
# This configuration supports multi-job DAG pipelines:
# - Master runs with --pipeline flag for DAG mode
# - Output directory mounted for job chaining
# - Pipeline config can specify multiple jobs

services:
  master:
    build: .
    container_name: dag_master
    command: python3 -m src.master.server --pipeline config/pipeline.json
    ports:
      - "50051:50051"
    networks:
      - dag_net
    environment:
      - PYTHONUNBUFFERED=1
      - DAG_MODE=true
    volumes:
      - ./src:/app/src
      - ./protos:/app/protos
      - ./data:/app/data
      - ./output:/app/output
      - ./config:/app/config

  worker1:
    build: .
    container_name: dag_worker1
    command: >
      sh -c "sleep 3 && python3 -m src.worker.client worker1"
    depends_on:
      - master
    networks:
      - dag_net
    environment:
      - PYTHONUNBUFFERED=1
      - MASTER_ADDRESS=master:50051
    volumes:
      - ./src:/app/src
      - ./protos:/app/protos
      - ./data:/app/data
      - ./intermediate:/app/intermediate
      - ./output:/app/output

  worker2:
    build: .
    container_name: dag_worker2
    command: >
      sh -c "sleep 3 && python3 -m src.worker.client worker2"
    depends_on:
      - master
    networks:
      - dag_net
    environment:
      - PYTHONUNBUFFERED=1
      - MASTER_ADDRESS=master:50051
    volumes:
      - ./src:/app/src
      - ./protos:/app/protos
      - ./data:/app/data
      - ./intermediate:/app/intermediate
      - ./output:/app/output

  worker3:
    build: .
    container_name: dag_worker3
    command: >
      sh -c "sleep 3 && python3 -m src.worker.client worker3"
    depends_on:
      - master
    networks:
      - dag_net
    environment:
      - PYTHONUNBUFFERED=1
      - MASTER_ADDRESS=master:50051
    volumes:
      - ./src:/app/src
      - ./protos:/app/protos
      - ./data:/app/data
      - ./intermediate:/app/intermediate
      - ./output:/app/output

networks:
  dag_net:
    driver: bridge
